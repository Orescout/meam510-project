<!DOCTYPE html>
<html>

<head>
  <style>
    /* Inspired by https://codepen.io/HJ-b/pen/jbPqWO */
    body {
      background: rgb(35, 35, 35);
      color: rgb(235, 235, 235)
    }

    .canvas {
      position: absolute;
      left:0px;
      top:200px;
    }

    .arrowbtn {
      position: absolute;
      width: 100px;
      height: 100px;
      background: rgba(17, 17, 17, 0);
      border: 2px solid hotpink;
      border-radius: 100px;
      color: hotpink;
      cursor: pointer;
      left: 50%;
      line-height: 100px;
      margin-left: -50px;
      transition: all 0.01s ease-in-out;
    }

    /* .arrowbtn:hover {
        background: white;
        border-color: white;
        color: #111;
      } */
    .arrowbtn:after {
      position: absolute;
      display: inline-block;
      content: "";
      width: 25px;
      height: 25px;
      top: 50%;
      left: 50%;
    }

    /* ~~~~~~~~ LOOK UP/DOWN/LEFT/RIGHT CSS ~~~~~~~~~~~~ */

    .arrowbtn-lookup { /* UP */
      left: 720px;
      top: 20px;
    }
    .arrowbtn-lookup:after {
      margin-left: -12.5px;
      margin-top: -6.25px;
      border-top: 2px solid;
      border-left: 2px solid;
      transform: rotateZ(45deg);
    }

    .arrowbtn-lookdown { /* DOWN */
      left: 720px;
      top: 200px;
    }
    .arrowbtn-lookdown:after {
      margin-left: -12.5px;
      margin-top: -18.75px;
      border-bottom: 2px solid;
      border-right: 2px solid;
      transform: rotateZ(45deg);
    }

    .arrowbtn-lookleft { /* LEFT */
      top: 100px;
      left: 590px;
    }
    .arrowbtn-lookleft:after {
      margin-left: -8.5px;
      margin-top: -13.75px;
      border-bottom: 2px solid;
      border-right: 2px solid;
      transform: rotateZ(135deg);
    }

    .arrowbtn-lookright { /* RIGHT */
      top: 100px;
      left: 850px;
    }
    .arrowbtn-lookright:after {
      margin-left: -17.5px;
      margin-top: -13.75px;
      border-bottom: 2px solid;
      border-right: 2px solid;
      transform: rotateZ(315deg);
    }

    /* ~~~~~~~~ MOVE UP/DOWN/LEFT/RIGHT CSS ~~~~~~~~~~~~ */

    .arrowbtn-moveup { /* UP */
      left: 720px;
      top: 420px;
    }
    .arrowbtn-moveup:after {
      margin-left: -12.5px;
      margin-top: -6.25px;
      border-top: 2px solid;
      border-left: 2px solid;
      transform: rotateZ(45deg);
    }

    .arrowbtn-movedown { /* DOWN */
      left: 720px;
      top: 600px;
    }
    .arrowbtn-movedown:after {
      margin-left: -12.5px;
      margin-top: -18.75px;
      border-bottom: 2px solid;
      border-right: 2px solid;
      transform: rotateZ(45deg);
    }

    .arrowbtn-moveleft { /* LEFT */
      top: 500px;
      left: 590px;
    }
    .arrowbtn-moveleft:after { 
      margin-left: -8.5px;
      margin-top: -13.75px;
      border-bottom: 2px solid;
      border-right: 2px solid;
      transform: rotateZ(135deg);
    }

    .arrowbtn-moveright { /* RIGHT */
      top: 500px;
      left: 850px;
    }
    .arrowbtn-moveright:after {
      margin-left: -17.5px;
      margin-top: -13.75px;
      border-bottom: 2px solid;
      border-right: 2px solid;
      transform: rotateZ(315deg);
    }
  </style>
</head>

<body>
  <b>Change Speed (type 0-9): </b>
  <input type="range" min="0" max="9" value="5" id="speed_slider">
  <span id="speed_display_text"> </span> <br> <br>

  <b>Key Pressed: </b>
  <span id="last_key_pressed_text"> </span> <br>

  <b>Server Response: </b>
  <span id="response_text"> </span> <br>

  <span class="arrowbtn arrowbtn-lookleft" id="arrow-lookleft"></span>
  <span class="arrowbtn arrowbtn-lookright" id="arrow-lookright"></span>

  <span class="arrowbtn arrowbtn-moveup" id="arrow-moveup"></span>
  <span class="arrowbtn arrowbtn-movedown" id="arrow-movedown"></span>
  <span class="arrowbtn arrowbtn-moveleft" id="arrow-moveleft"></span>
  <span class="arrowbtn arrowbtn-moveright" id="arrow-moveright"></span>
  
  <canvas class="canvas" id="canvas-background" width="705" height="285" style="border:1px solid #ffffff;"></canvas>
  <canvas class="canvas" id="canvas-robot" width="705" height="285"></canvas>
  <canvas class="canvas" id="canvas-IR-vision" width="705" height="285"></canvas>

</body>

<script>

  function toggleColor(element_ID, condition) {
    if (condition) { // ON
      document.getElementById(element_ID).style.background = "rgba(255, 255, 255, 1)";
    } else { // OFF
      document.getElementById(element_ID).style.background = "rgba(255, 255, 255, 0)";
    }
  }

  function setSpeed(speed) {
    document.getElementById("speed_slider").value = speed;
    document.getElementById("speed_display_text").innerHTML = speed.toString();
  }

  function sendToESP(text) {
    var xhttp = new XMLHttpRequest();
    var url = "key_pressed?val=" + text;

    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById("response_text").innerHTML = this.responseText;
      }
    };

    xhttp.open("GET", url, true);
    xhttp.send();
  }

  var map = {}; // You could also use an array

  onkeydown = onkeyup = function (e) {
    e = e || event; // to deal with IE
    previousMapString = JSON.stringify(map); // save the previous map
    map[e.keyCode] = e.type == 'keydown'; // mark true the index of any key that's pressed.

    if (JSON.stringify(map) !== previousMapString) {
      document.getElementById("last_key_pressed_text").innerHTML = JSON.stringify(map);
      console.log(JSON.stringify(map));
      sendToESP(JSON.stringify(map));
    }

    // Look
    toggleColor("arrow-lookleft", map[37]); // ArrowLeft
    toggleColor("arrow-lookright", map[39]); // ArrowRight
    
    // Move
    toggleColor("arrow-moveup", map[87]); // W
    toggleColor("arrow-movedown", map[83]); // S
    toggleColor("arrow-moveleft", map[65]); // A
    toggleColor("arrow-moveright", map[68]); // D

    // Speed
    if (map[48] || map[49] || map[50] || map[51] || map[52] || map[53] || map[54] || map[55] || map[56] || map[57]) {
      setSpeed(e.key);
    }
  }

  
  var robot_width = 50;
  var robot_height = 50;
  var robot_x_coordinate = 25;
  var robot_y_coordinate = 200;
  var degrees_robot = 90;
  var see_700Hz_beacon = 1;
  var see_32Hz_beacon = 0;

  // Declare drawing objects
  var ctx_background = document.getElementById("canvas-background").getContext("2d");
  var ctx_robot = document.getElementById("canvas-robot").getContext("2d");
  var ctx_IR_vision = document.getElementById("canvas-IR-vision").getContext("2d");

  drawCanvasBackground();
  
  function drawCanvasBackground() {
    var h = document.getElementById("canvas-background").clientHeight;
    var w = document.getElementById("canvas-background").clientWidth;

    ctx_background.fillStyle = "#003366";
    ctx_background.fillRect(0, 0, w / 2, h); // draw our side

    ctx_background.fillStyle = "#660033";
    ctx_background.fillRect(w / 2, 0, w / 2, h); // draw opposite side
    
    ctx_background.strokeStyle = "rgba(0, 0, 0, 0.8)";
    ctx_background.strokeRect(w / 4, h / 5, w / 8, h * (3/5)); // left 2x points box
    ctx_background.strokeRect(w * (7.5/12), h / 5, w / 8, h * (3/5)); // right 2x points box
  
  }

  moveRobot(robot_x_coordinate, robot_y_coordinate, degrees_robot, see_700Hz_beacon, see_32Hz_beacon);

  function moveRobot(x_coordinate, y_coordinate, degrees_facing, see_700Hz_beacon, see_32Hz_beacon) {
    var offset_degrees = 135;
    var radius = Math.sqrt((robot_width/2) ** 2 + (robot_height/2) ** 2);

    // Get new coordinates of top left corner, after displacement rcos(theta) and rsin(theta)
    var top_left_corner_x_coordinates = x_coordinate + radius * Math.cos((degrees_facing - offset_degrees) * Math.PI / 180);
    var top_left_corner_y_coordinates = y_coordinate + radius * Math.sin((degrees_facing - offset_degrees) * Math.PI / 180);

    // Draw robot location rectangle
    ctx_robot.fillStyle = "rgba(255, 255, 255, 0.6)";
    ctx_robot.translate(top_left_corner_x_coordinates, top_left_corner_y_coordinates);
    ctx_robot.rotate(degrees_facing * Math.PI / 180);
    ctx_robot.fillRect(0, 0, robot_width, robot_height);
    
    // Draw robot direction triangle
    ctx_robot.fillStyle = "rgba(255, 0, 0, 0.7)";
    ctx_robot.beginPath();
    ctx_robot.moveTo(robot_width * 0.2, robot_width/5);
    ctx_robot.lineTo(robot_width * 0.5, 0);
    ctx_robot.lineTo(robot_width * 0.8, robot_width/5);
    ctx_robot.fill();

    // Draw where robot sees with Infrared Receiver 700Hz
    (see_700Hz_beacon) ? ctx_robot.fillStyle = "rgba(255, 255, 0, 0.6)" : ctx_robot.fillStyle = "rgba(255, 255, 0, 0.1)";
    ctx_robot.beginPath();
    ctx_robot.moveTo(robot_width * 0.2, 0);
    ctx_robot.lineTo(robot_width * 0.5, -document.getElementById("canvas-background").clientWidth);
    ctx_robot.lineTo(robot_width * 0.5, 0);
    ctx_robot.fill();

    // Draw where robot sees with Infrared Receiver 32Hz
    (see_32Hz_beacon) ? ctx_robot.fillStyle = "rgba(0, 255, 0, 0.6)" : ctx_robot.fillStyle = "rgba(0, 255, 0, 0.1)";
    ctx_robot.beginPath();
    ctx_robot.moveTo(robot_width * 0.8, 0);
    ctx_robot.lineTo(robot_width * 0.5, -document.getElementById("canvas-background").clientWidth);
    ctx_robot.lineTo(robot_width * 0.5, 0);
    ctx_robot.fill();
   }


</script>